<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>链接</title>
    <link href="../../../Scripts/easyUI145/themes/icon.css" rel="stylesheet" type="text/css" />
    <link href="../../../Scripts/easyUI145/themes/default/easyui.css" rel="stylesheet" type="text/css" />
    <link href="../../../../DataUser/Style/ccbpm.css" rel="stylesheet" type="text/css" />
    <script src="../../../Scripts/easyUI145/jquery.min.js" type="text/javascript"></script>
    <script src="../../../Scripts/easyUI145/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="../../../Scripts/QueryString.js" type="text/javascript"></script>
    <script src="../../../Scripts/config.js" type="text/javascript"></script>
    <script src="../../../Scripts/QueryString.js" type="text/javascript"></script>
    <script src="../../../Comm/Gener.js" type="text/javascript"></script>
    <script src="../../../Admin/Admin.js"></script>

    <script type="text/javascript">
        $(function () {

            var handler = new HttpHandler("BP.CCBill.WF_CCBill_Admin_DBList");
            handler.AddUrlData();
            var data = handler.DoMethodReturnJSON("FieldsORM_Init");

            var frmID = GetQueryString("FrmID");

            var dblist = new Entity("BP.CCBill.DBList", frmID);

            dblist.ExpEn = dblist.ExpEn.replace('~', '\'');
            dblist.ExpEn = dblist.ExpEn.replace('~', '\'');


            $("#TB_DBSrc").val(dblist.ExpEn);

            var bakAttrs = new Entities("BP.Sys.MapAttrs", frmID + "Bak");
            //  var attrs = new Entities("BP.Sys.MapAttrs", frmID);

            var html = "<table>";
            html += "<tr>";
            html += "<th>Idx</th>";
            html += "<th>字段</th>";
            html += "<th>字段名</th>";
            html += "<th>返回类型</th>";
            html += "<th>映射的类型</th>";
            html += "<th>业务类型</th>";
            html += "<th>操作</th>";
            html += "<th>取消映射</th>";
            html += "</tr>";

            for (var i = 0; i < data.length; i++) {
                var en = data[i];

                var barkEn = null;

                for (var idx = 0; idx < bakAttrs.length; idx++) {
                    var bakAttr = bakAttrs[idx];
                    if (en.No === bakAttr.KeyOfEn)
                        barkEn = bakAttr;
                }

                //如果集合里没有，创建一个.
                if (barkEn == null) {

                    barkEn = new Entity("BP.Sys.MapAttr");
                    barkEn.FK_MapData = frmID + "Bak";
                    barkEn.KeyOfEn = en.No;
                    barkEn.Name = en.No;

                    barkEn.DataType = 1; //string类型.

                    if (en.DBType == "Int32" || en.DBType == "Int64") {
                        barkEn.MyDataType = 2; //int类型.
                    }

                    if (en.DBType == "Decimal" || en.DBType == "Float") {
                        barkEn.MyDataType = 3; //float 类型.
                    }

                    barkEn.Insert();
                }

                html += "<tr>";
                html += "<td>" + i + "</td>";
                html += "<td>" + barkEn.KeyOfEn + "</td>";
                html += "<td>" + barkEn.Name + "</td>";
                html += "<td>" + en.DBType + "</td>";
                html += "<td>" + GetDataType(barkEn.MyDataType) + "</td>";

                if (barkEn.LGType == 0) html += "<td>普通属性字段</td>";
                if (barkEn.LGType == 1) html += "<td>枚举</td>";
                if (barkEn.LGType == 2) html += "<td>外键</td>";


                var oper = "<a href=\"javascript:Edit('" + barkEn.MyPK + "')\">编辑</a>";

                if (barkEn.MyDataType == 1) {
                    oper += "|<a href=\"javascript:Edit('" + barkEn.MyPK + "')\">转成int类型</a>";
                    oper += "|<a href=\"javascript:Edit('" + barkEn.MyPK + "')\">转成外键</a>";
                }

                if (barkEn.MyDataType == 2) {
                    oper += "|<a href=\"javascript:Edit('" + barkEn.MyPK + "')\">转成boolen类型</a>";
                    oper += "|<a href=\"javascript:Edit('" + barkEn.MyPK + "')\">转成枚举类型</a>";
                }

                html += "<td>" + oper + " </td>";

                var oper = "<a href=\"javascript:Del('" + barkEn.MyPK + "')\">取消</a>";

                html += "<td>" + oper + " </td>";

                html += "</tr>";
            }
            html += "</table>";

            $("#docs").html(html);

        });

        function GetDataType(datatype) {
            if (datatype == 1) return "String";
            if (datatype == 2) return "Int";
            if (datatype == 3) return "Float";
            if (datatype == 4) return "Boolean";
            if (datatype == 5) return "Double";
            if (datatype == 6) return "Date";
            if (datatype == 7) return "DateTime";
            if (datatype == 8) return "Money";
        }


        function Edit(mypk) {
            var barkEn = new Entity("BP.Sys.MapAttr", mypk);

            var url = "";

            if (barkEn.MyDataType == 1)
                url = "../../../Comm/En.htm?EnName=BP.Sys.FrmUI.MapAttrString&MyPK=" + mypk;

            if (barkEn.MyDataType == 2 || barkEn.MyDataType == 3 || barkEn.MyDataType == 5)
                url = "../../../Comm/En.htm?EnName=BP.Sys.FrmUI.MapAttrNum&MyPK=" + mypk;

            if (barkEn.MyDataType == 6 || barkEn.MyDataType == 7)
                url = "../../../Comm/En.htm?EnName=BP.Sys.FrmUI.MapAttrDate&MyPK=" + mypk;

            WinOpen(url);
        }

        function Save() {
            var frmID = GetQueryString("FrmID");
            var dblist = new Entity("BP.CCBill.DBList", frmID);
            dblist.ExpEn = $("#TB_DBSrc").val();
            dblist.Update();
            window.location.href = window.location.href;
        }
        function App() {
            var handler = new HttpHandler("BP.CCBill.WF_CCBill_Admin_DBList");
            handler.AddUrlData();
            var data = handler.DoMethodReturnJSON("FieldsORM_App");
        }
    </script>
</head>
<body>
    <div id="bar">
    </div>

    <fieldset>
        <legend>单笔记录数据源，必须有：OID,BillNo,Title 字段.</legend>
        <textarea value="" id="TB_DBSrc" name="TB_DBSrc">
        </textarea>
        <input type="button" value="获取数据结构" id="Btn_Save" onclick="Save()" />
        <legend>
            字段列表：
        </legend>

        <div id="docs"></div>
        <input type="button" value="提交应用" id="Btn_App" onclick="App()" /> .


        <legend>
            说明：
        </legend>
        <ul>

            <li> 只有提交应用才能生效 </li>
            <li> 如果字段类型不匹配，请打开字段属性，进行编辑，然后把string类型的转化为其他类型. </li>

        </ul>

    </fieldset>


</body>
</html>
